"use strict";!function(){angular.module("Campaign",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,n,e,o,a,i,c,r,s,u){var l=this;l.accountInfo={},l.getAccount=function(){t.account().then(function(t){200==t.status&&(l.accountInfo=t.data,new Date(l.accountInfo.tokenExpire)<new Date&&(l.accountInfo.accessToken=""))})},l.init=function(){l.getAccount(),n.getCampaigns().then(function(t){200==t.status?l.listCampaigns=t.data:c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},l.saveCampaign=function(t){if(!t)return void c.error("Kiểm tra lại dữ liệu và thử lại.","Lỗi!");n.saveCampaign(l.campaign).then(function(t){if(200==t.status){if(l.campaign._id){for(var n in l.listCampaigns)if(l.listCampaigns[n]._id==l.campaign._id){l.listCampaigns[n]=t.data;break}}else l.listCampaigns||(l.listCampaigns=[]),l.listCampaigns.unshift(t.data);l.campaign=t.data,c.success("Lưu bài đăng thành công.","Thành công!")}else c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},l.removeCampaign=function(t,e){confirm("Bạn có chắc chắn muốn xóa?")&&n.removeCampaign(t).then(function(t){200==t.status&&t.data?(c.success("Xóa bài đăng thành công.","Thành công!"),l.listCampaigns.splice(e,1),l.resetCampaign()):c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},l.runCampaign=function(t){confirm("Bạn chắc chắn muốn chạy chiến dịch này?")&&n.runCampaign(t).then(function(t){200==t.status&&t.data?c.success(t.data.msg,"Thành công!"):c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){c.error(t.data.message,"Lỗi!")})},l.selectCampaign=function(t){l.campaign=t,Common.scrollTo("#campaign-top","fast"),l.postTypeChange()},l.resetCampaign=function(){l.campaign={}},l.postTypeChange=function(){"feed"==l.campaign.postType?e.getFeeds().then(function(t){200==t.status?l.listFeeds=t.data:c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}):o.getAlbums().then(function(t){200==t.status?l.listAlbums=t.data:c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})}}t.$inject=["UserService","CampaignService","FeedService","AlbumService","$cookies","$rootScope","toastr","$timeout","$facebook","$http"],angular.module("Campaign").controller("CampaignController",t)}(),function(){function t(t){return{getCampaigns:function(){return t.get(apiPath+"/api/campaign/getCampaigns")},saveCampaign:function(n){return t.post(apiPath+"/api/campaign/saveCampaign",n)},removeCampaign:function(n){return t.post(apiPath+"/api/campaign/removeCampaign",{campaignId:n})},runCampaign:function(n){return t.post(apiPath+"/api/campaign/runCampaign",{campaignId:n})},stopCampaign:function(n){return t.post(apiPath+"/api/campaign/stopCampaign",{campaignId:n})}}}t.$inject=["$http"],angular.module("Campaign").service("CampaignService",t)}(),function(){angular.module("Album",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,n,e,o,a,i,c,r,s){var u=this;u.accountInfo={},u.getAccount=function(){t.account().then(function(t){200==t.status&&(u.accountInfo=t.data,new Date(u.accountInfo.tokenExpire)<new Date&&(u.accountInfo.accessToken=""))})},u.init=function(){u.getAccount(),n.getAlbums().then(function(t){200==t.status?u.listAlbums=t.data:a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},u.saveAlbum=function(t){if(!t)return void a.error("Kiểm tra lại dữ liệu và thử lại.","Lỗi!");u.album.photos||(u.album.photos=[]),u.tmpPhotoNames&&(u.album.photos=u.album.photos.concat(u.tmpPhotoNames)),n.saveAlbum(u.album).then(function(t){if(200==t.status){var n=[];console.log("image",u.tmpPhotos,u.tmpPhotoNames),u.tmpPhotos.map(function(e,o){var a=u.tmpPhotoNames[o];n.push(function(n){s.upload({url:apiPath+"/api/upload/image",data:{file:e,filename:a.replace(/.[^.]+$/g,""),type:"albums/"+t.data._id}}).then(function(t){console.log("success",t),n(null)},function(t){console.log("err",t),n(!0)},function(t){})})}),async.parallel(n,function(n,e){if(u.defaultPhotos(),u.album._id){for(var o in u.listAlbums)if(u.listAlbums[o]._id==u.album._id){u.listAlbums[o]=t.data;break}}else u.listAlbums||(u.listAlbums=[]),u.listAlbums.unshift(t.data);u.album=t.data,a.success("Lưu bài đăng thành công.","Thành công!")})}else a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},u.removeAlbum=function(t,e){confirm("Bạn có chắc chắn muốn xóa?")&&n.removeAlbum(t).then(function(t){200==t.status&&t.data?(a.success("Xóa bài đăng thành công.","Thành công!"),u.listAlbums.splice(e,1),u.resetAlbum()):a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},u.selectAlbum=function(t){u.album=t,u.defaultPhotos(),Common.scrollTo("#album-top","fast")},u.resetAlbum=function(){u.album={},u.defaultPhotos()},u.defaultPhotos=function(){u.tmpPhotos=[],u.tmpPhotoNames=[]},u.defaultPhotos(),u.uploadFiles=function(t,n){console.log(t,n);for(var e in t){var o=t[e];u.tmpPhotoNames.push((new Date).getTime()+"-"+o.name),u.tmpPhotos.push(o)}},u.removePhoto=function(t){u.tmpPhotos.splice(t,1),u.tmpPhotoNames.splice(t,1)},u.removeSavedPhoto=function(t){u.album.photos.splice(t,1)}}t.$inject=["UserService","AlbumService","$cookies","$rootScope","toastr","$timeout","$facebook","$http","Upload"],angular.module("Album").controller("AlbumController",t)}(),function(){function t(t){return{getAlbums:function(){return t.get(apiPath+"/api/album/getAlbums")},saveAlbum:function(n){return t.post(apiPath+"/api/album/saveAlbum",n)},removeAlbum:function(n){return t.post(apiPath+"/api/album/removeAlbum",{albumId:n})}}}t.$inject=["$http"],angular.module("Album").service("AlbumService",t)}();var Common=function(){return{scrollTo:function(t,n){t=t||"html,body",n=n||"slow",$("html,body").animate({scrollTop:$(t).offset().top},n)}}}();!function(){angular.module("Core",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(){return{restrict:"AE",templateUrl:"modules/web-core/views/js/template/error-message.html",replace:!0,scope:{errorMessage:"=",matchTarget:"=",typeContent:"="},link:function(t,n,e){function o(){t.typeContent!=t.matchTarget?t.errorMessage.match=!0:t.errorMessage.match=!1}t.$watch("typeContent",function(t){o()}),t.$watch("matchTarget",function(t){o()})}}}function n(){return{restrict:"A",scope:{showLoading:"="},link:function(t,n,e){t.$watch("showLoading",function(t){t&&$(n).fadeIn()})}}}angular.module("Core").directive("errorMessage",t).directive("showLoading",n)}(),function(){function t(t,n,e){return{response:function(n){return 200==n.status&&(n.data.noAccessToken&&t.$broadcast("NO_ACCESS_TOKEN_ERROR"),n.data.tokenHasExpired&&t.$broadcast("TOKEN_HAS_EXPIRED_ERROR"),n.data.rejectApi)?e.reject({status:!1,data:{message:"You have access token!"},handle:"PreResponse"}):n}}}t.$inject=["$rootScope","$timeout","$q"],angular.module("Core").factory("PreResponse",t).config(["$httpProvider",function(t){t.interceptors.push("PreResponse")}])}(),function(){angular.module("Feed",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,n,e,o,a,i,c,r){var s=this;s.accountInfo={},s.getAccount=function(){t.account().then(function(t){200==t.status&&(s.accountInfo=t.data,new Date(s.accountInfo.tokenExpire)<new Date&&(s.accountInfo.accessToken=""))})},s.init=function(){s.getAccount(),n.getFeeds().then(function(t){200==t.status?s.listFeeds=t.data:a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},s.saveFeed=function(t){if(!t)return void a.error("Kiểm tra lại dữ liệu và thử lại.","Lỗi!");n.saveFeed(s.feed).then(function(t){if(200==t.status){if(s.feed._id){for(var n in s.listFeeds)if(s.listFeeds[n]._id==s.feed._id){s.listFeeds[n]=t.data;break}}else s.listFeeds||(s.listFeeds=[]),s.listFeeds.unshift(t.data);s.feed=t.data,a.success("Lưu trạng thái thành công.","Thành công!")}else a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},s.removeFeed=function(t,e){confirm("Bạn có chắc chắn muốn xóa?")&&n.removeFeed(t).then(function(t){200==t.status&&t.data?(a.success("Xóa trạng thái thành công.","Thành công!"),s.listFeeds.splice(e,1),s.resetFeed()):a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},s.selectFeed=function(t){s.feed=t,Common.scrollTo("#feed-top","fast")},s.resetFeed=function(){s.feed={}}}t.$inject=["UserService","FeedService","$cookies","$rootScope","toastr","$timeout","$facebook","$http"],angular.module("Feed").controller("FeedController",t)}(),function(){function t(t){return{getFeeds:function(){return t.get(apiPath+"/api/feed/getFeeds")},saveFeed:function(n){return t.post(apiPath+"/api/feed/saveFeed",n)},removeFeed:function(n){return t.post(apiPath+"/api/feed/removeFeed",{feedId:n})}}}t.$inject=["$http"],angular.module("Feed").service("FeedService",t)}(),function(){angular.module("Graph",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,n,e,o,a,i,c,r,s,u,l){var p=this;p.accountInfo={},p.getAccount=function(){t.account().then(function(t){200==t.status&&(p.accountInfo=t.data,new Date(p.accountInfo.tokenExpire)<new Date&&(p.accountInfo.accessToken=""))})},p.init=function(){p.getAccount(),n.getFeeds().then(function(t){200==t.status?p.listFeeds=t.data:c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}),o.getAlbums().then(function(t){200==t.status?p.listAlbums=t.data:c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},p.postPhotoToAlbum=function(){var t=[];p.albumId.photos.map(function(n){t.push(function(t){console.log("ss",l.settings.services.webUrl+"/files/albums/"+p.albumId._id+"/"+n),e.graphApi(p.accountInfo.accessToken,"post","/"+p.createdAlbumId+"/photos",{url:"https://www.w3schools.com/css/img_fjords.jpg"}).then(function(n){200==n.status?t(null,n.data):t(!0)}).catch(function(){t(!0)})})}),async.parallel(t,function(t,n){t?(console.log("POST PHOTO",t),c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")):c.success("Đăng hình ảnh lên album thành công.","Thành công!")})},p.postGroup=function(t){if(!t)return void c.error("Kiểm tra lại dữ liệu và thử lại sau.","Lỗi!");var n;0==p.postType?n=e.graphApi(p.accountInfo.accessToken,"post","/"+p.groupId+"/feed",{message:p.feedId.message}):1==p.postType&&(n=e.graphApi(p.accountInfo.accessToken,"post","/"+p.groupId+"/albums",{name:p.albumId.name,message:p.albumId.message})),n.then(function(t){200==t.status?(console.log("Post group data:",t.data),c.success("Đã đăng lên nhóm thành công.","Thành công!"),1==p.postType&&(p.createdAlbumId=t.data.id,p.createdAlbumId&&p.postPhotoToAlbum())):c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){console.log("Err",t),c.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})}}t.$inject=["UserService","FeedService","GraphService","AlbumService","$cookies","$rootScope","toastr","$timeout","$facebook","$http","$window"],angular.module("Graph").controller("GraphController",t)}(),function(){function t(t){return{graphApi:function(n,e,o,a){return e=e?e.toLowerCase():"get",e="get"==e?e:"post",a||(a={}),a.accessToken=n,a.apiUrl=o,a.method=e,t.post(apiPath+"/api/user/graphApi",a)}}}t.$inject=["$http"],angular.module("Graph").service("GraphService",t)}(),function(){angular.module("User",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,n,e,o,a,i,c){function r(e,i,c){t.update(e).then(function(t){console.log("Resp",t),c=c||"Cập nhật tài khoản thành công.",i&&(c+=" Đang làm mới trang."),o.success("Cập nhật tài khoản thành công!","Thông báo!"),t.data.appId&&n.put("appId",t.data.appId,{path:"/"}),i&&a(function(){window.location.reload()},2e3)}).catch(function(t){var n=t.data;o.error(n.message||n,"Thông báo!")})}var s=this;s.accountInfo={},s.showLoading=!1,s.showApiError=function(t){-1==window.location.href.search("trang-ca-nhan")&&(o.error(t,"Lỗi"),a(function(){window.location.href=window.settings.services.webUrl+"/trang-ca-nhan"},2e3))},e.$on("NO_ACCESS_TOKEN_ERROR",function(){s.showApiError("Bạn chưa có mã truy cập, hãy đến trang cá nhân, bổ sung thông tin và nhận mã truy cập.")}),e.$on("TOKEN_HAS_EXPIRED_ERROR",function(){s.showApiError("Mã truy cập đã hết hạn, hãy đến trang cá nhân và cập nhật mã truy cập.")}),s.getAccount=function(){t.account().then(function(t){200==t.status&&(s.accountInfo=t.data,t.data.appId&&t.data.appSecret&&(s.appIdValid=!0),new Date(s.accountInfo.tokenExpire)<new Date&&(s.accountInfo.accessToken=""),s.showLoading=!0)})},s.getAccount(),s.login=function(e){if(!e)return void o.error("Kiểm tra lại dữ liệu và thử lại.","Lỗi!");t.login({email:s.form.email,password:s.form.password}).then(function(t){console.log("Resp",t),n.put("token",t.data.token,{path:"/"}),n.put("appId",t.data.appId,{path:"/"}),window.location.reload()})},s.logout=function(){t.logout().then(function(t){n.remove("token"),window.location.reload()}).catch(function(t){n.remove("token"),window.location.reload()})},s.register=function(n){if(!n)return void o.error("Kiểm tra lại thông tin đã nhập.","Lỗi!");t.register({email:s.form.email,password:s.form.password,name:s.form.name}).then(function(t){console.log("Resp",t),o.success("Đăng ký tài khoản thành công!","Thông báo!"),a(function(){s.login(!0)},2e3)}).catch(function(t){var n=t.data;o.error(n.message||n,"Thông báo!")})},s.update=function(t){if(!t)return void o.error("Kiểm tra lại thông tin đã nhập.","Lỗi!");r({name:s.accountInfo.name,appId:s.accountInfo.appId,accessToken:s.accountInfo.accessToken,appSecret:s.accountInfo.appSecret,tokenExpire:s.accountInfo.tokenExpire},!0)},s.getAccessToken=function(){i.login().then(function(t){console.log("getAccessToken",t),t.authResponse&&t.authResponse.accessToken&&s.extendToken(t.authResponse.accessToken)})},s.extendToken=function(n){t.extendAccessToken({accessToken:n,appId:s.accountInfo.appId,appSecret:s.accountInfo.appSecret}).then(function(t){200==t.status&&(s.accountInfo.accessToken=t.data.access_token,s.accountInfo.tokenExpire=new Date((new Date).getTime()+1e3*t.data.expires_in),s.update(!0))})},s.getGroupInfo=function(t){if(t){var n=t.match(/\/groups\/(.*)\//g)[0].replace(/\/groups\/(.*)\//g,"$1");n&&i.api("/search?q="+n+"&type=group&access_token="+s.accountInfo.accessToken).then(function(t){if(t.data){for(var n in t.data){var e=t.data[n],o=!1;for(var a in s.accountInfo.groups){var i=s.accountInfo.groups[a];if(e.id==i.id){o=!0;break}}o||s.accountInfo.groups.unshift(e)}r({groups:s.accountInfo.groups},!1,"Đã cập nhật danh sách nhóm thành công.")}},function(t){console.log("group info",t)})}},s.removeGroup=function(t){confirm("Bạn có chắc chắn muốn xóa?")&&(s.accountInfo.groups.splice(t,1),r({groups:s.accountInfo.groups},!1,"Đã cập nhật danh sách nhóm thành công."))}}t.$inject=["UserService","$cookies","$rootScope","toastr","$timeout","$facebook","$http"],angular.module("User").controller("UserController",t)}(),function(){function t(t){var n;return{login:function(n){return t({method:"POST",url:apiPath+"/api/user/login",data:n})},logout:function(n){return t({method:"GET",url:apiPath+"/api/user/logout"})},account:function(e){return n||(n=t({method:"GET",url:apiPath+"/api/user/account"})),n},register:function(n){return t({method:"POST",url:apiPath+"/api/user/register",data:n})},update:function(n){return t({method:"POST",url:apiPath+"/api/user/update",data:n})},extendAccessToken:function(n){return t({method:"POST",url:apiPath+"/api/user/extendAccessToken",data:n})}}}t.$inject=["$http"],angular.module("User").service("UserService",t)}();var apiPath=window.location.origin;window.location.port&&(apiPath=window.settings.services.apiUrl),function(){var t=["User","Core","Feed","Graph","Album","Campaign","ngCookies","ngAnimate","toastr","angular-loading-bar","ngMessages","ngFacebook","ngFileUpload"];angular.module("HapiApp",t).config(["$httpProvider","$facebookProvider",function(t,n){t.defaults.withCredentials=!0,window.appId&&(n.setAppId(window.appId),n.setPermissions("email,publish_actions,user_managed_groups,user_photos"))}]).run(["$window",function(t){window.appId&&function(){if(!document.getElementById("facebook-jssdk")){var t=document.getElementsByTagName("script")[0],n=document.createElement("script");n.id="facebook-jssdk",n.src="//connect.facebook.net/en_US/all.js",t.parentNode.insertBefore(n,t)}}()}])}();