"use strict";!function(){angular.module("Album",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,e,n,o,a,c,i,r,s){var u=this;u.accountInfo={},u.getAccount=function(){t.account().then(function(t){200==t.status&&(u.accountInfo=t.data,new Date(u.accountInfo.tokenExpire)<new Date&&(u.accountInfo.accessToken="",a.error("Access token đã hết hạn, hãy làm mới access token để có thể tiếp tục sử dụng.","Cảnh báo!")))})},u.init=function(){u.getAccount(),e.getAlbums().then(function(t){200==t.status?u.listAlbums=t.data:a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},u.saveAlbum=function(t){if(!t)return void a.error("Kiểm tra lại dữ liệu và thử lại.","Lỗi!");u.album.photos||(u.album.photos=[]),u.tmpPhotoNames&&(u.album.photos=u.album.photos.concat(u.tmpPhotoNames)),e.saveAlbum(u.album).then(function(t){if(200==t.status){var e=[];console.log("image",u.tmpPhotos,u.tmpPhotoNames),u.tmpPhotos.map(function(n,o){var a=u.tmpPhotoNames[o];e.push(function(e){s.upload({url:apiPath+"/api/upload/image",data:{file:n,filename:a.replace(/.[^.]+$/g,""),type:"albums/"+t.data._id}}).then(function(t){console.log("success",t),e(null)},function(t){console.log("err",t),e(!0)},function(t){})})}),async.parallel(e,function(e,n){if(u.defaultPhotos(),u.album._id){for(var o in u.listAlbums)if(u.listAlbums[o]._id==u.album._id){u.listAlbums[o]=t.data;break}}else u.listAlbums||(u.listAlbums=[]),u.listAlbums.unshift(t.data);u.album=t.data,a.success("Lưu bài đăng thành công.","Thành công!")})}else a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},u.removeAlbum=function(t,n){confirm("Bạn có chắc chắn muốn xóa?")&&e.removeAlbum(t).then(function(t){200==t.status&&t.data?(a.success("Xóa bài đăng thành công.","Thành công!"),u.listAlbums.splice(n,1),u.resetAlbum()):a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},u.selectAlbum=function(t){u.album=t,u.defaultPhotos(),Common.scrollTo("#album-top","fast")},u.resetAlbum=function(){u.album={},u.defaultPhotos()},u.defaultPhotos=function(){u.tmpPhotos=[],u.tmpPhotoNames=[]},u.defaultPhotos(),u.uploadFiles=function(t,e){console.log(t,e);for(var n in t){var o=t[n];u.tmpPhotoNames.push((new Date).getTime()+"-"+o.name),u.tmpPhotos.push(o)}},u.removePhoto=function(t){u.tmpPhotos.splice(t,1),u.tmpPhotoNames.splice(t,1)},u.removeSavedPhoto=function(t){u.album.photos.splice(t,1)}}t.$inject=["UserService","AlbumService","$cookies","$rootScope","toastr","$timeout","$facebook","$http","Upload"],angular.module("Album").controller("AlbumController",t)}(),function(){function t(t){return{getAlbums:function(){return t.get(apiPath+"/api/album/getAlbums")},saveAlbum:function(e){return t.post(apiPath+"/api/album/saveAlbum",e)},removeAlbum:function(e){return t.post(apiPath+"/api/album/removeAlbum",{albumId:e})}}}t.$inject=["$http"],angular.module("Album").service("AlbumService",t)}();var Common=function(){return{scrollTo:function(t,e){t=t||"html,body",e=e||"slow",$("html,body").animate({scrollTop:$(t).offset().top},e)}}}();!function(){angular.module("Core",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}();var sideMenu=function(){return{open:function(){},close:function(){}}}();!function(){function t(){return{restrict:"AE",templateUrl:"modules/web-core/views/js/template/error-message.html",replace:!0,scope:{errorMessage:"=",matchTarget:"=",typeContent:"="},link:function(t,e,n){function o(){t.typeContent!=t.matchTarget?t.errorMessage.match=!0:t.errorMessage.match=!1}t.$watch("typeContent",function(t){o()}),t.$watch("matchTarget",function(t){o()})}}}angular.module("Core").directive("errorMessage",t)}(),function(){angular.module("Feed",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,e,n,o,a,c,i,r){var s=this;s.accountInfo={},s.getAccount=function(){t.account().then(function(t){200==t.status&&(s.accountInfo=t.data,new Date(s.accountInfo.tokenExpire)<new Date&&(s.accountInfo.accessToken="",a.error("Access token đã hết hạn, hãy làm mới access token để có thể tiếp tục sử dụng.","Cảnh báo!")))})},s.init=function(){s.getAccount(),e.getFeeds().then(function(t){200==t.status?s.listFeeds=t.data:a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},s.saveFeed=function(t){if(!t)return void a.error("Kiểm tra lại dữ liệu và thử lại.","Lỗi!");e.saveFeed(s.feed).then(function(t){if(200==t.status){if(s.feed._id){for(var e in s.listFeeds)if(s.listFeeds[e]._id==s.feed._id){s.listFeeds[e]=t.data;break}}else s.listFeeds||(s.listFeeds=[]),s.listFeeds.unshift(t.data);s.feed=t.data,a.success("Lưu bài đăng thành công.","Thành công!")}else a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},s.removeFeed=function(t,n){confirm("Bạn có chắc chắn muốn xóa?")&&e.removeFeed(t).then(function(t){200==t.status&&t.data?(a.success("Xóa bài đăng thành công.","Thành công!"),s.listFeeds.splice(n,1),s.resetFeed()):a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){a.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},s.selectFeed=function(t){s.feed=t,Common.scrollTo("#feed-top","fast")},s.resetFeed=function(){s.feed={}}}t.$inject=["UserService","FeedService","$cookies","$rootScope","toastr","$timeout","$facebook","$http"],angular.module("Feed").controller("FeedController",t)}(),function(){function t(t){return{getFeeds:function(){return t.get(apiPath+"/api/feed/getFeeds")},saveFeed:function(e){return t.post(apiPath+"/api/feed/saveFeed",e)},removeFeed:function(e){return t.post(apiPath+"/api/feed/removeFeed",{feedId:e})}}}t.$inject=["$http"],angular.module("Feed").service("FeedService",t)}(),function(){angular.module("Graph",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,e,n,o,a,c,i,r,s,u,l){var h=this;h.accountInfo={},h.getAccount=function(){t.account().then(function(t){200==t.status&&(h.accountInfo=t.data,new Date(h.accountInfo.tokenExpire)<new Date&&(h.accountInfo.accessToken="",i.error("Access token đã hết hạn, hãy làm mới access token để có thể tiếp tục sử dụng.","Cảnh báo!")))})},h.init=function(){h.getAccount(),e.getFeeds().then(function(t){200==t.status?h.listFeeds=t.data:i.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){i.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}),o.getAlbums().then(function(t){200==t.status?h.listAlbums=t.data:i.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(){i.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})},h.postPhotoToAlbum=function(){var t=[];h.albumId.photos.map(function(e){t.push(function(t){console.log("ss",l.settings.services.webUrl+"/files/albums/"+h.albumId._id+"/"+e),n.graphApi(h.accountInfo.accessToken,"post","/"+h.createdAlbumId+"/photos",{url:"https://www.w3schools.com/css/img_fjords.jpg"}).then(function(e){200==e.status?t(null,e.data):t(!0)}).catch(function(){t(!0)})})}),async.parallel(t,function(t,e){t?(console.log("POST PHOTO",t),i.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")):i.success("Đăng hình ảnh lên album thành công.","Thành công!")})},h.postGroup=function(t){if(!t)return void i.error("Kiểm tra lại dữ liệu và thử lại sau.","Lỗi!");var e;0==h.postType?e=n.graphApi(h.accountInfo.accessToken,"post","/"+h.groupId+"/feed",{message:h.feedId.message}):1==h.postType&&(e=n.graphApi(h.accountInfo.accessToken,"post","/"+h.groupId+"/albums",{name:h.albumId.name,message:h.albumId.message})),e.then(function(t){200==t.status?(console.log("Post group data:",t.data),i.success("Đã đăng lên nhóm thành công.","Thành công!"),1==h.postType&&(h.createdAlbumId=t.data.id,h.createdAlbumId&&h.postPhotoToAlbum())):i.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")}).catch(function(t){console.log("Err",t),i.error("Có lỗi xảy ra, thử lại sau.","Lỗi!")})}}t.$inject=["UserService","FeedService","GraphService","AlbumService","$cookies","$rootScope","toastr","$timeout","$facebook","$http","$window"],angular.module("Graph").controller("GraphController",t)}(),function(){function t(t){return{graphApi:function(e,n,o,a){return n=n?n.toLowerCase():"get",n="get"==n?n:"post",a||(a={}),a.accessToken=e,a.apiUrl=o,a.method=n,t.post(apiPath+"/api/user/graphApi",a)}}}t.$inject=["$http"],angular.module("Graph").service("GraphService",t)}(),function(){angular.module("User",[]).config(["$interpolateProvider",function(t){t.startSymbol("{["),t.endSymbol("]}")}])}(),function(){function t(t,e,n,o,a,c,i){function r(n,c,i){t.update(n).then(function(t){console.log("Resp",t),i=i||"Cập nhật tài khoản thành công.",c&&(i+=" Đang làm mới trang."),o.success("Cập nhật tài khoản thành công!","Thông báo!"),t.data.appId&&e.put("appId",t.data.appId,{path:"/"}),c&&a(function(){window.location.reload()},2e3)}).catch(function(t){var e=t.data;o.error(e.message||e,"Thông báo!")})}var s=this;s.accountInfo={},s.getAccount=function(){t.account().then(function(t){200==t.status&&(s.accountInfo=t.data,new Date(s.accountInfo.tokenExpire)<new Date&&(s.accountInfo.accessToken="",o.error("Access token đã hết hạn, hãy làm mới access token để có thể tiếp tục sử dụng.","Cảnh báo!")))})},s.getAccount(),s.login=function(n){if(!n)return void o.error("Kiểm tra lại dữ liệu và thử lại.","Lỗi!");t.login({email:s.form.email,password:s.form.password}).then(function(t){console.log("Resp",t),e.put("token",t.data.token,{path:"/"}),e.put("appId",t.data.appId,{path:"/"}),window.location.reload()})},s.logout=function(){t.logout().then(function(t){e.remove("token"),window.location.reload()}).catch(function(t){e.remove("token"),window.location.reload()})},s.register=function(e){if(!e)return void o.error("Kiểm tra lại thông tin đã nhập.","Lỗi!");t.register({email:s.form.email,password:s.form.password,name:s.form.name}).then(function(t){console.log("Resp",t),o.success("Đăng ký tài khoản thành công!","Thông báo!"),a(s.login,2e3)}).catch(function(t){var e=t.data;o.error(e.message||e,"Thông báo!")})},s.update=function(t){if(!t)return void o.error("Kiểm tra lại thông tin đã nhập.","Lỗi!");r({name:s.accountInfo.name,appId:s.accountInfo.appId,accessToken:s.accountInfo.accessToken,appSecret:s.accountInfo.appSecret,tokenExpire:s.accountInfo.tokenExpire},!0)},s.getAccessToken=function(){c.login().then(function(t){console.log("getAccessToken",t),t.authResponse&&t.authResponse.accessToken&&s.extendToken(t.authResponse.accessToken)})},s.extendToken=function(e){t.extendAccessToken({accessToken:e,appId:s.accountInfo.appId,appSecret:s.accountInfo.appSecret}).then(function(t){200==t.status&&(s.accountInfo.accessToken=t.data.access_token,s.accountInfo.tokenExpire=new Date((new Date).getTime()+1e3*t.data.expires_in),s.update(!0))})},s.getGroupInfo=function(t){if(t){var e=t.match(/\/groups\/(.*)\//g)[0].replace(/\/groups\/(.*)\//g,"$1");e&&c.api("/search?q="+e+"&type=group&access_token="+s.accountInfo.accessToken).then(function(t){if(t.data){for(var e in t.data){var n=t.data[e],o=!1;for(var a in s.accountInfo.groups){var c=s.accountInfo.groups[a];if(n.id==c.id){o=!0;break}}o||s.accountInfo.groups.unshift(n)}r({groups:s.accountInfo.groups},!1,"Đã cập nhật danh sách nhóm thành công.")}},function(t){console.log("group info",t)})}},s.removeGroup=function(t){confirm("Bạn có chắc chắn muốn xóa?")&&(s.accountInfo.groups.splice(t,1),r({groups:s.accountInfo.groups},!1,"Đã cập nhật danh sách nhóm thành công."))}}t.$inject=["UserService","$cookies","$rootScope","toastr","$timeout","$facebook","$http"],angular.module("User").controller("UserController",t)}(),function(){function t(t){var e;return{login:function(e){return t({method:"POST",url:apiPath+"/api/user/login",data:e})},logout:function(e){return t({method:"GET",url:apiPath+"/api/user/logout"})},account:function(n){return e||(e=t({method:"GET",url:apiPath+"/api/user/account"})),e},register:function(e){return t({method:"POST",url:apiPath+"/api/user/register",data:e})},update:function(e){return t({method:"POST",url:apiPath+"/api/user/update",data:e})},extendAccessToken:function(e){return t({method:"POST",url:apiPath+"/api/user/extendAccessToken",data:e})}}}t.$inject=["$http"],angular.module("User").service("UserService",t)}();var apiPath=window.location.origin;window.location.port&&(apiPath=window.settings.services.apiUrl),function(){var t=["User","Core","Feed","Graph","Album","ngCookies","ngAnimate","toastr","angular-loading-bar","ngMessages","ngFacebook","ngFileUpload"];angular.module("HapiApp",t).config(["$httpProvider","$facebookProvider",function(t,e){t.defaults.withCredentials=!0,window.appId&&(e.setAppId(window.appId),e.setPermissions("email,publish_actions,user_managed_groups,user_photos"))}]).run(["$window",function(t){window.appId&&function(){if(!document.getElementById("facebook-jssdk")){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.id="facebook-jssdk",e.src="//connect.facebook.net/en_US/all.js",t.parentNode.insertBefore(e,t)}}()}])}();